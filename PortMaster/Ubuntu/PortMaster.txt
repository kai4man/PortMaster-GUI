#!/bin/bash
# make by G.R.H
#
# SPDX-License-Identifier: MIT
#
## HRMMM

export HOME="/root"
DSIPLAY_ID="$(cat /sys/class/power_supply/axp2202-battery/display_id)"

if [[ $DSIPLAY_ID == "1" ]]; then
  export AUDIODEV=hw:2,0
else
  if [ -f "/roms/lib64/libSDL2-2.0.so.0.2800.6" ]; then
    LD_PRELOAD=/roms/lib64/libSDL2-2.0.so.0.2800.6
  fi
fi

controlfolder="/roms/ports/PortMaster"
SH_DIR="$(cd $(dirname "$0"); pwd)"
directory="mnt/$(echo "$SH_DIR" | cut -d '/' -f3)/Roms"
# MIYOO_EXtra shit i need.
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib32
ESUDO=""
ESUDOKILL="-1" # for 351Elec and EmuELEC use "-1" (numeric one) or "-k" 
export SDL_GAMECONTROLLERCONFIG_FILE="/usr/lib/gamecontrollerdb.txt"
# export SDL_GAMECONTROLLERCONFIG=$(grep "Deeplay" "/usr/lib/gamecontrollerdb.txt")
source "$controlfolder/device_info.txt"
[ -f "${controlfolder}/mod_${CFW_NAME}.txt" ] && source "${controlfolder}/mod_${CFW_NAME}.txt"
## TODO: Change to PortMaster/tty when Johnnyonflame merges the changes in,
CUR_TTY=/dev/null
cd "$controlfolder"
exec > >(tee "$controlfolder/log.txt") 2>&1
source "$controlfolder/utils/pmsplash.txt"
## Autoinstallation Code
# This will automatically install zips found within the PortMaster/autoinstall directory using harbourmaster
AUTOINSTALL=$(find "$controlfolder/autoinstall" -type f \( -name "*.zip" -o -name "*.squashfs" \))
if [ -n "$AUTOINSTALL" ]; then
  source "$controlfolder/PortMasterDialog.txt"
  GW=$(PortMasterIPCheck)
  PortMasterDialogInit "no-check"
  PortMasterDialog "messages_begin"
  PortMasterDialog "message" "Auto-installation"
  # Install the latest runtimes.zip
  if [ -f "$controlfolder/autoinstall/runtimes.zip" ]; then
    PortMasterDialog "message" "- Installing runtimes.zip, this could take a minute or two."
    $ESUDO unzip -o "$controlfolder/autoinstall/runtimes.zip" -d "$controlfolder/libs"
    $ESUDO rm -f "$controlfolder/autoinstall/runtimes.zip"
    PortMasterDialog "message" "- SUCCESS: runtimes.zip"
  fi
  for file_name in "$controlfolder/autoinstall"/*.squashfs
  do
    if [ ! -f "$file_name" ]; then
      continue
    fi
    $ESUDO mv -f "$file_name" "$controlfolder/libs"
    PortMasterDialog "message" "- SUCCESS: $(basename $file_name)"
  done
  for file_name in "$controlfolder/autoinstall"/*.zip
  do
    if [ ! -f "$file_name" ]; then
      continue
    fi
    if [[ "$(basename $file_name)" == "PortMaster.zip" ]]; then
      continue
    fi
    if [[ $(PortMasterDialogResult "install" "$file_name") == "OKAY" ]]; then
      $ESUDO rm -f "$file_name"
      PortMasterDialog "message" "- SUCCESS: $(basename $file_name)"
    else
      PortMasterDialog "message" "- FAILURE: $(basename $file_name)"
    fi
    touch "$controlfolder/.muos-refresh"
  done
  if [ -f "$controlfolder/autoinstall/PortMaster.zip" ]; then
    if [ ! -f "$file_name" ]; then
      continue
    fi
    file_name="$controlfolder/autoinstall/PortMaster.zip"
    if [[ $(PortMasterDialogResult "install" "$file_name") == "OKAY" ]]; then
      $ESUDO rm -f "$file_name"
      PortMasterDialog "message" "- SUCCESS: $(basename $file_name)"
    else
      PortMasterDialog "message" "- FAILURE: $(basename $file_name)"
    fi
  fi
  PortMasterDialog "messages_end"
  if [ -z "$GW" ]; then
    PortMasterDialogMessageBox "Finished running autoinstall.

No internet connection present so exiting."
    PortMasterDialogExit
    exit 0
  else
    PortMasterDialogMessageBox "Finished running autoinstall."
    PortMasterDialogExit
  fi
fi


export TERM=linux

# # Do it twice, it's just as nice!
# cat /dev/zero > /dev/fb0 2>/dev/null
# cat /dev/zero > /dev/fb0 2>/dev/null

pm_message "Starting PortMaster."

$ESUDO chmod -R +x .

unset LD_LIBRARY_PATH
unset SDL_GAMECONTROLLERCONFIG
PATH="$OLD_PATH"
